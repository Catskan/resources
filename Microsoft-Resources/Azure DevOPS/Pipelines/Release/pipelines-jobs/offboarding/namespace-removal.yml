jobs:
- job: job_namespace_removal
  pool:
    name: $(agent-pool-name)
    demands:
    - agent.os -equals Linux

  steps:
  #take variables to be used from the shared Azure Keyvault
  - task: AzureKeyVault@1
    displayName: Shared Azurekeyvault Variables Import
    inputs:
      azureSubscription: '$(azure-subscription)'
      KeyVaultName: '$(shared-keyvault)'
      SecretsFilter: '*'
      runAsPreJob: true
  
  #getting AKS credentials and check if the namespace exists
  - task: AzureCLI@2
    displayName: Get AKS credentials & check if namespace exists
    inputs:
      azureSubscription: '$(azure-subscription)'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az login --identity
        az aks get-credentials --resource-group $(aks-resource-group) --name $(aks-cluster-name) --overwrite-existing --file /home/azureuser/.kube/config
        export KUBECONFIG=/home/azureuser/.kube/config
        kubelogin convert-kubeconfig -l msi
        if kubectl get namespace $(CUSTOMERNAME); then
          echo "namespace exists, will be deleted"
          echo "##vso[task.setvariable variable=DeleteNamespace;]true"
        else          
          echo "namespace doesn't exist"
          echo "##vso[task.setvariable variable=DeleteNamespace;]false"
        fi

  #delete namespace
  - task: Kubernetes@1
    condition: eq(variables.DeleteNamespace, True)
    displayName: Delete tenant namespace
    inputs:
      connectionType: 'None'
      command: 'delete'
      arguments: 'namespace $(CUSTOMERNAME)'
      secretType: 'generic'